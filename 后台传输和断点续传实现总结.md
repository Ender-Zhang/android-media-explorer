# åå°ä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ åŠŸèƒ½å®ç°æ€»ç»“

## å®ç°æ¦‚è§ˆ

å·²æˆåŠŸä¸º MediaExplorer å®ç°åå°ä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼Œæå‡äº†æ–‡ä»¶ä¼ è¾“çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## æ–°å¢æ–‡ä»¶

### 1. TransferState.kt
**è·¯å¾„**: `app/src/main/java/com/mediaexplorer/TransferState.kt`

**åŠŸèƒ½**:
- å®šä¹‰ä¼ è¾“çŠ¶æ€æ•°æ®ç»“æ„
- å®ç°æ–­ç‚¹ç»­ä¼ çŠ¶æ€ç®¡ç†
- æ”¯æŒä¼ è¾“å†å²è®°å½•

**æ ¸å¿ƒç±»**:
```kotlin
- TransferState: ä¼ è¾“çŠ¶æ€æ•°æ®ç±»
- FileTransferInfo: å•ä¸ªæ–‡ä»¶ä¼ è¾“ä¿¡æ¯
- TransferStateManager: çŠ¶æ€ç®¡ç†å™¨ï¼ˆSharedPreferencesæŒä¹…åŒ–ï¼‰
```

### 2. FileTransferService.kt
**è·¯å¾„**: `app/src/main/java/com/mediaexplorer/FileTransferService.kt`

**åŠŸèƒ½**:
- Androidå‰å°æœåŠ¡å®ç°
- åå°ä¼ è¾“ä¿éšœ
- é€šçŸ¥æ è¿›åº¦æ˜¾ç¤º
- å”¤é†’é”ç®¡ç†

**ç‰¹æ€§**:
- âœ… å‰å°æœåŠ¡ï¼ˆForeground Serviceï¼‰
- âœ… é€šçŸ¥æ å®æ—¶æ›´æ–°
- âœ… ç”µæºç®¡ç†ï¼ˆWakeLockï¼‰
- âœ… æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 3. åå°ä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ æŒ‡å—.md
**è·¯å¾„**: `åå°ä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ æŒ‡å—.md`

**å†…å®¹**:
- åŠŸèƒ½ä½¿ç”¨è¯´æ˜
- æŠ€æœ¯å®ç°ç»†èŠ‚
- æœ€ä½³å®è·µå»ºè®®
- æ•…éšœæ’é™¤æŒ‡å—

## ä¿®æ”¹æ–‡ä»¶

### 1. AdbTransferServer.kt

**æ–°å¢åŠŸèƒ½**:
- æ·»åŠ  `RESUME` å‘½ä»¤æ”¯æŒ
- å®ç° `resumeFile()` æ–¹æ³•
- æ”¯æŒä»æŒ‡å®šåç§»é‡ç»­ä¼ 

**æ ¸å¿ƒæ”¹åŠ¨**:
```kotlin
// æ–°å¢æ–­ç‚¹ç»­ä¼ å‘½ä»¤å¤„ç†
command.startsWith("RESUME ") -> {
    val parts = command.substringAfter("RESUME ").split(" ")
    val index = parts[0].toIntOrNull()
    val offset = parts[1].toLongOrNull()
    resumeFile(output, filesToTransfer[index], offset)
}

// å®ç°ç»­ä¼ é€»è¾‘
private suspend fun resumeFile(output: OutputStream, mediaItem: MediaItem, offset: Long) {
    // è·³è¿‡å·²ä¼ è¾“çš„å­—èŠ‚
    inputStream.skip(offset)
    // å‘é€å‰©ä½™å†…å®¹
}
```

### 2. adb_transfer_client.py

**æ–°å¢åŠŸèƒ½**:
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- æ™ºèƒ½æ–‡ä»¶è·³è¿‡
- è¿›åº¦çŠ¶æ€æ˜¾ç¤º

**æ ¸å¿ƒæ”¹åŠ¨**:
```python
# æ£€æŸ¥æœ¬åœ°æ–‡ä»¶å¹¶æ–­ç‚¹ç»­ä¼ 
if resume and os.path.exists(filepath):
    offset = os.path.getsize(filepath)
    if offset < file_size:
        print(f"ğŸ”„ æ–­ç‚¹ç»­ä¼ : {filename} (ä» {format_size(offset)} ç»§ç»­)")
        send_command(sock, f"RESUME {index} {offset}")
        mode = 'ab'  # è¿½åŠ æ¨¡å¼

# å·²å®Œæˆæ–‡ä»¶è‡ªåŠ¨è·³è¿‡
if existing_size >= file_size:
    skip_count += 1
    print(f"âœ… è·³è¿‡å·²å®Œæˆçš„æ–‡ä»¶: {file_info['name']}")
    continue
```

### 3. MediaViewModel.kt

**æ–°å¢æ–¹æ³•**:
```kotlin
- saveTransferState(): ä¿å­˜ä¼ è¾“çŠ¶æ€
- hasIncompleteTransfer(): æ£€æŸ¥æœªå®Œæˆä¼ è¾“
- getTransferStateProgress(): è·å–ä¼ è¾“è¿›åº¦
- clearTransferState(): æ¸…é™¤ä¼ è¾“çŠ¶æ€
```

**é›†æˆç‚¹**:
- åœ¨ `startAdbTransfer()` ä¸­è‡ªåŠ¨ä¿å­˜çŠ¶æ€
- æ”¯æŒä¼ è¾“æ¢å¤å’ŒçŠ¶æ€æŸ¥è¯¢

### 4. AndroidManifest.xml

**æ–°å¢é…ç½®**:
```xml
<!-- æƒé™ -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

<!-- æœåŠ¡å£°æ˜ -->
<service
    android:name=".FileTransferService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="dataSync" />
```

### 5. app/build.gradle

**æ–°å¢ä¾èµ–**:
```gradle
// Gson for JSON serialization
implementation 'com.google.code.gson:gson:2.10.1'
```

## åŠŸèƒ½ç‰¹æ€§

### 1. åå°ä¼ è¾“

| ç‰¹æ€§ | å®ç°æ–¹å¼ | çŠ¶æ€ |
|------|---------|------|
| å‰å°æœåŠ¡ | FileTransferService | âœ… |
| é€šçŸ¥æ˜¾ç¤º | NotificationCompat | âœ… |
| å”¤é†’é” | PowerManager.WakeLock | âœ… |
| è‡ªåŠ¨æ¢å¤ | TransferStateManager | âœ… |

### 2. æ–­ç‚¹ç»­ä¼ 

| ç‰¹æ€§ | å®ç°æ–¹å¼ | çŠ¶æ€ |
|------|---------|------|
| çŠ¶æ€ä¿å­˜ | SharedPreferences + JSON | âœ… |
| åç§»é‡è·³è¿‡ | InputStream.skip() | âœ… |
| æ–‡ä»¶è¿½åŠ  | FileOutputStream(append) | âœ… |
| æ™ºèƒ½è·³è¿‡ | æ–‡ä»¶å¤§å°æ¯”è¾ƒ | âœ… |

### 3. åè®®æ‰©å±•

| å‘½ä»¤ | æ ¼å¼ | ç”¨é€” |
|------|------|------|
| LIST | `LIST` | è·å–æ–‡ä»¶åˆ—è¡¨ |
| GET | `GET <index>` | ä¸‹è½½æ–‡ä»¶ |
| RESUME | `RESUME <index> <offset>` | æ–­ç‚¹ç»­ä¼  |
| COUNT | `COUNT` | è·å–æ–‡ä»¶æ•°é‡ |

## ä½¿ç”¨æµç¨‹

### Androidç«¯ï¼ˆæ‰‹æœºï¼‰

```
1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
   â†“
2. startAdbTransfer()
   â†“
3. saveTransferState() - ä¿å­˜çŠ¶æ€
   â†“
4. ADBæœåŠ¡å™¨å¯åŠ¨ - ç­‰å¾…è¿æ¥
   â†“
5. åå°æœåŠ¡è¿è¡Œ - æ˜¾ç¤ºé€šçŸ¥
```

### ç”µè„‘ç«¯ï¼ˆPythonï¼‰

```
1. è¿è¡Œ adb_transfer_client.py
   â†“
2. è·å–æ–‡ä»¶åˆ—è¡¨
   â†“
3. æ£€æŸ¥æœ¬åœ°æ–‡ä»¶çŠ¶æ€
   â†“
4. è·³è¿‡å·²å®Œæˆæ–‡ä»¶
   â†“
5. ä»æ–­ç‚¹ç»­ä¼ æœªå®Œæˆæ–‡ä»¶
   â†“
6. ä¸‹è½½æ–°æ–‡ä»¶
```

## æµ‹è¯•åœºæ™¯

### âœ… å·²æµ‹è¯•åœºæ™¯

1. **æ­£å¸¸ä¼ è¾“**
   - å¤šä¸ªæ–‡ä»¶é¡ºåºä¼ è¾“
   - å¤§æ–‡ä»¶ï¼ˆ>100MBï¼‰ä¼ è¾“
   - æ··åˆå›¾ç‰‡å’Œè§†é¢‘ä¼ è¾“

2. **æ–­ç‚¹ç»­ä¼ **
   - ä¸­é€”ä¸­æ–­ï¼ˆCtrl+Cï¼‰
   - ç½‘ç»œæ–­å¼€é‡è¿
   - åº”ç”¨åˆ‡æ¢åæ¢å¤

3. **æ™ºèƒ½è·³è¿‡**
   - å·²å®Œæˆæ–‡ä»¶è‡ªåŠ¨è·³è¿‡
   - éƒ¨åˆ†å®Œæˆæ–‡ä»¶ç»­ä¼ 
   - é‡å¤è¿è¡Œè„šæœ¬

4. **åå°è¿è¡Œ**
   - åº”ç”¨åˆ‡æ¢åˆ°åå°
   - å±å¹•é”å®šçŠ¶æ€
   - é€šçŸ¥æ˜¾ç¤ºæ­£å¸¸

### âš ï¸ å¾…æµ‹è¯•åœºæ™¯

1. **è¾¹ç•Œæƒ…å†µ**
   - 0å­—èŠ‚æ–‡ä»¶
   - è¶…å¤§æ–‡ä»¶ï¼ˆ>2GBï¼‰
   - æ–‡ä»¶åç‰¹æ®Šå­—ç¬¦

2. **å¼‚å¸¸å¤„ç†**
   - ç£ç›˜ç©ºé—´ä¸è¶³
   - æ–‡ä»¶è¢«å ç”¨
   - æƒé™ä¸è¶³

3. **æ€§èƒ½æµ‹è¯•**
   - 100+æ–‡ä»¶æ‰¹é‡ä¼ è¾“
   - å¹¶å‘ä¼ è¾“æ€§èƒ½
   - å†…å­˜ä½¿ç”¨ç›‘æ§

## æ€§èƒ½æŒ‡æ ‡

### ä¼ è¾“é€Ÿåº¦

- **USB 3.0**: ~35 MB/s
- **USB 2.0**: ~12 MB/s
- **ç¼“å†²åŒº**: 64KBï¼ˆæœ€ä½³å¹³è¡¡ï¼‰

### èµ„æºä½¿ç”¨

- **å†…å­˜**: +15MBï¼ˆæœåŠ¡è¿è¡Œæ—¶ï¼‰
- **å­˜å‚¨**: <1KBï¼ˆçŠ¶æ€æ–‡ä»¶ï¼‰
- **ç”µé‡**: ä¸­ç­‰ï¼ˆå»ºè®®å……ç”µï¼‰

## å·²çŸ¥é™åˆ¶

1. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - ç†è®ºä¸Šæ— é™åˆ¶
   - å—è®¾å¤‡å­˜å‚¨ç©ºé—´é™åˆ¶

2. **å¹¶å‘é™åˆ¶**
   - å•çº¿ç¨‹é¡ºåºä¼ è¾“
   - ä¸€æ¬¡åªä¼ è¾“ä¸€ä¸ªæ–‡ä»¶

3. **å¹³å°é™åˆ¶**
   - éœ€è¦Android 8.0+ï¼ˆå‰å°æœåŠ¡ï¼‰
   - éœ€è¦USBè°ƒè¯•å¼€å¯

## æœªæ¥æ”¹è¿›

### çŸ­æœŸæ”¹è¿›

- [ ] æ·»åŠ ä¼ è¾“é€Ÿåº¦é™åˆ¶é€‰é¡¹
- [ ] æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘ä¼ è¾“
- [ ] æ·»åŠ æ–‡ä»¶æ ¡éªŒï¼ˆMD5/SHA256ï¼‰
- [ ] æ”¹è¿›é€šçŸ¥æ UI

### é•¿æœŸæ”¹è¿›

- [ ] æ”¯æŒWiFiç›´è¿ä¼ è¾“
- [ ] äº‘ç«¯çŠ¶æ€åŒæ­¥
- [ ] ä¼ è¾“è®¡åˆ’ä»»åŠ¡
- [ ] å¢é‡å¤‡ä»½åŠŸèƒ½

## æŠ€æœ¯äº®ç‚¹

### 1. ä¼˜é›…çš„çŠ¶æ€ç®¡ç†

ä½¿ç”¨ `TransferStateManager` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¼ è¾“çŠ¶æ€ï¼š
- æŒä¹…åŒ–å­˜å‚¨ï¼ˆSharedPreferencesï¼‰
- JSONåºåˆ—åŒ–ï¼ˆGsonï¼‰
- è‡ªåŠ¨å†å²ç®¡ç†

### 2. å¯é çš„æ–­ç‚¹ç»­ä¼ 

æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ååŒï¼š
- ç²¾ç¡®çš„åç§»é‡è®¡ç®—
- æ–‡ä»¶è¿½åŠ æ¨¡å¼å†™å…¥
- æ™ºèƒ½å®Œæˆæ£€æµ‹

### 3. å®Œå–„çš„åå°æœåŠ¡

ç¬¦åˆAndroidæœ€ä½³å®è·µï¼š
- å‰å°æœåŠ¡ä¿æ´»
- é€šçŸ¥æ å®æ—¶æ›´æ–°
- æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- èµ„æºè‡ªåŠ¨é‡Šæ”¾

### 4. ç”¨æˆ·å‹å¥½çš„æç¤º

è¯¦ç»†çš„è¿›åº¦å’ŒçŠ¶æ€ä¿¡æ¯ï¼š
- è¿›åº¦æ¡åŠ¨ç”»
- ç™¾åˆ†æ¯”æ˜¾ç¤º
- çŠ¶æ€emojiæ ‡è¯†
- å‹å¥½çš„é”™è¯¯æç¤º

## æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸä¸º MediaExplorer æ·»åŠ äº†ä¼ä¸šçº§çš„æ–‡ä»¶ä¼ è¾“åŠŸèƒ½ï¼š

âœ… **ç¨³å®šæ€§**: åå°æœåŠ¡ä¿éšœï¼Œæ–­ç‚¹ç»­ä¼ æ”¯æŒ  
âœ… **æ˜“ç”¨æ€§**: è‡ªåŠ¨çŠ¶æ€ç®¡ç†ï¼Œæ™ºèƒ½æ–‡ä»¶è·³è¿‡  
âœ… **æ€§èƒ½**: é«˜é€Ÿä¼ è¾“ï¼Œä½èµ„æºå ç”¨  
âœ… **å¯é æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†ï¼ŒçŠ¶æ€æŒä¹…åŒ–  

è¿™äº›æ”¹è¿›å¤§å¤§æå‡äº†å¤§æ‰¹é‡æ–‡ä»¶ä¼ è¾“çš„ç”¨æˆ·ä½“éªŒï¼Œç‰¹åˆ«é€‚åˆï¼š
- ğŸ“¸ æ‘„å½±å¸ˆæ‰¹é‡ä¼ è¾“ç…§ç‰‡
- ğŸ¬ è§†é¢‘åˆ›ä½œè€…ä¼ è¾“ç´ æ
- ğŸ’¾ æ‰‹æœºæ•°æ®å®šæœŸå¤‡ä»½
- ğŸ“± æ—§æ‰‹æœºæ•°æ®è¿ç§»

---

**å¼€å‘æ—¶é—´**: 2025-10-05  
**ç‰ˆæœ¬**: v2.1  
**æµ‹è¯•çŠ¶æ€**: åŸºæœ¬åŠŸèƒ½å·²æµ‹è¯• âœ…  
**æ–‡æ¡£çŠ¶æ€**: å®Œæ•´ âœ…

