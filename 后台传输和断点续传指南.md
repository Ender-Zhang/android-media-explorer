# 后台传输和断点续传功能指南

## 功能概述

MediaExplorer 现已支持后台传输和断点续传功能，让文件传输更加稳定可靠。

## 主要特性

### 1. 后台传输服务

- **前台服务保护**：传输过程在前台服务中运行，确保即使应用切换到后台也能继续传输
- **通知栏显示**：实时显示传输进度和状态
- **唤醒锁保持**：防止设备休眠中断传输
- **自动恢复**：意外中断后可自动从断点恢复

### 2. 断点续传

- **智能续传**：传输中断后，再次运行可从断点继续，无需重新传输
- **状态保存**：自动保存每个文件的传输进度
- **文件校验**：支持跳过已完整下载的文件
- **进度显示**：清晰显示每个文件的传输状态

## 使用方法

### Android端（手机）

#### 1. 启动传输

```kotlin
// 在应用中选择文件后，启动ADB传输
viewModel.startAdbTransfer(
    onSuccess = {
        // 传输服务启动成功
        // 状态已自动保存，支持断点续传
    },
    onError = { error ->
        // 处理错误
    }
)
```

#### 2. 传输状态监控

```kotlin
// 检查是否有未完成的传输
val hasIncomplete = viewModel.hasIncompleteTransfer()

// 获取传输进度
val progress = viewModel.getTransferStateProgress()

// 清除传输状态（传输完成后）
viewModel.clearTransferState()
```

### 电脑端（Python客户端）

#### 1. 基本使用

```bash
# 标准下载（支持断点续传）
python3 adb_transfer_client.py

# 指定下载目录
python3 adb_transfer_client.py ~/Downloads/MyPhotos
```

#### 2. 断点续传演示

```bash
# 第一次下载（假设中途中断）
$ python3 adb_transfer_client.py

📱 获取文件列表...

📋 找到 3 个文件:
   1. 🖼️ IMG_001.jpg (5.23 MB)
   2. 🎬 VID_002.mp4 (125.67 MB)
   3. 🖼️ IMG_003.jpg (3.45 MB)

💾 保存目录: /Users/username/Downloads/MediaExplorer
🔄 断点续传已启用

开始下载...

[1/3] 📥 下载: IMG_001.jpg (5.23 MB)
   [████████████████████████████████████████] 100.0%
✅ 下载完成

[2/3] 📥 下载: VID_002.mp4 (125.67 MB)
   [████████████████░░░░░░░░░░░░░░░░░░░░░░░░] 40.0%
⚠️  下载已中断
💡 提示: 再次运行脚本可从断点继续下载

# 再次运行，从断点继续
$ python3 adb_transfer_client.py

📱 获取文件列表...

📋 找到 3 个文件:
   1. 🖼️ IMG_001.jpg (5.23 MB) ✓已完成
   2. 🎬 VID_002.mp4 (125.67 MB) 🔄40%
   3. 🖼️ IMG_003.jpg (3.45 MB)

[1/3] ✅ 跳过已完成的文件: IMG_001.jpg

[2/3] 🔄 断点续传: VID_002.mp4 (从 50.27 MB 继续)
   [████████████████████████████████████████] 100.0%
✅ 下载完成

[3/3] 📥 下载: IMG_003.jpg (3.45 MB)
   [████████████████████████████████████████] 100.0%
✅ 下载完成

============================================================
📊 传输完成!
   ✅ 成功: 3 个文件
   ⏭️  跳过: 1 个文件（已存在）
   ⏱️  用时: 45.2 秒
============================================================
```

## 技术实现

### 1. 服务端（Android）

#### 传输状态管理

```kotlin
data class TransferState(
    val transferId: String,
    val files: List<FileTransferInfo>,
    val timestamp: Long,
    val isCompleted: Boolean
)

data class FileTransferInfo(
    val filePath: String,
    val fileName: String,
    val fileSize: Long,
    val transferredBytes: Long,
    val isCompleted: Boolean
)
```

#### 断点续传协议

服务器支持 `RESUME` 命令：

```
客户端: RESUME <fileIndex> <offset>
服务器: OK\n<fileSize>\n<offset>\n<fileName>\n<remainingData>
```

### 2. 客户端（Python）

#### 断点续传逻辑

```python
# 检查本地文件
if os.path.exists(filepath):
    offset = os.path.getsize(filepath)
    if offset < file_size:
        # 从断点继续
        send_command(sock, f"RESUME {index} {offset}")
        mode = 'ab'  # 追加模式
```

## 最佳实践

### 1. 大文件传输

对于大文件（>100MB），断点续传特别有用：

- 网络不稳定时自动保存进度
- 可以随时中断和恢复
- 避免重复传输已下载的部分

### 2. 批量传输

传输多个文件时：

- 已完成的文件会自动跳过
- 未完成的文件从断点继续
- 节省时间和带宽

### 3. 后台运行

Android端特性：

- 应用切换到后台也能继续传输
- 通知栏实时显示进度
- 传输完成后自动通知

## 故障排除

### 问题1：断点续传失败

**症状**：重新运行后从头开始下载

**解决方案**：
- 确保使用最新版本的客户端脚本
- 检查文件名是否匹配
- 不要手动删除或移动未完成的文件

### 问题2：传输在后台停止

**症状**：应用切换到后台后传输中断

**解决方案**：
- 确认已授予后台运行权限
- 在系统设置中关闭电池优化
- 保持手机充电状态

### 问题3：进度显示不准确

**症状**：进度百分比跳跃或不更新

**解决方案**：
- 这是正常现象，进度每秒更新一次
- 大文件可能需要几秒才能看到明显变化
- 等待传输完成即可

## 高级功能

### 1. 传输历史查看

```kotlin
// 获取传输历史
val history = transferStateManager.getTransferHistory()

// 清除历史
transferStateManager.clearTransferHistory()
```

### 2. 自定义保存路径

```bash
# 指定自定义目录
python3 adb_transfer_client.py /path/to/custom/directory
```

### 3. 选择性恢复

```python
# 只下载未完成的文件
for file in file_list:
    if not is_file_complete(file):
        download_file(file, resume=True)
```

## 性能优化

### 1. 传输速度

- USB 3.0：约 30-40 MB/s
- USB 2.0：约 10-15 MB/s
- 影响因素：USB接口、手机性能、文件类型

### 2. 内存使用

- 缓冲区大小：64KB（最佳平衡）
- 状态文件：<1KB per transfer
- 通知占用：最小

### 3. 电池消耗

- 前台服务：中等消耗
- 建议连接充电器进行大批量传输
- 完成后自动释放唤醒锁

## 安全性

### 1. 数据隔离

- 每次传输使用唯一ID
- 状态文件加密存储（可选）
- 传输完成后自动清理

### 2. 权限管理

- 仅需必要的文件读取权限
- 网络传输限制在本地ADB连接
- 不上传任何数据到云端

## 更新日志

### v2.1（当前版本）

- ✅ 添加后台传输服务
- ✅ 实现断点续传功能
- ✅ 添加传输状态管理
- ✅ 支持批量文件智能跳过
- ✅ 改进传输进度显示
- ✅ 增强错误处理和恢复

### v2.0

- 基础ADB传输功能
- WiFi传输支持
- 增量传输

## 反馈和支持

如遇到问题或有建议，请：

1. 查看本指南的故障排除部分
2. 检查日志文件获取详细错误信息
3. 在GitHub提交Issue

---

**注意**：断点续传功能需要服务器端和客户端都支持。请确保两端都已更新到最新版本。

